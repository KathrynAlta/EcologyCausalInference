---
title: "ggdag_demo"
author: "Laura Dee"
date: "`r Sys.Date()`"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Learning Objectives


First, I highly recommend this live demonstration and tutorial by Andrew Heiss [here](https://www.youtube.com/watch?v=uoAjyyToUTE)

# The Context: Let's Start Simple
Let's consider that we are investigating the effect of a species invasion on native biodiversity. We also know that land-use (nearby agricultural conversion) and nutrient additions (from fertilizer) help facilitate invasion, and nutrients can reduce native plant biodiversity (REF). Climate also affects both native biodiversity and the invasive species' abundances. We formalize this knowledge in the following DAG, after loading the packages we will use.

```{r cars}
## Load Packages
library(ggdag)
require(knitr)
library(dagitty)
require(tidyr)
require(ddplyr)
library(tidyverse)
# install.packages("devtools")
devtools::install_github("lbusett/insert_table") 
library(inserttable)

```

```{r}
## Specify the DAG
DAG_invasion_effects <- dagify(
  invasion ~ nutrients + climate + landuse,
  native_biodiversity ~ invasion + nutrients + climate,
  nutrients ~ landuse 
)
plot(DAG_invasion_effects)
```

Next, we ned to identify which variable is the outcome of interest, and which is the treatment or exposure. Here are are considering the effect of invasion on native biodiversity. We can plot this nicely with ggdag. Here I set the seed when plotting because otherwise the DAG shows up in different orientations each time! 

```{r}
DAG_invasion_effects <- dagify(
  invasion ~ nutrients + climate + landuse,
  native_biodiversity ~ invasion + nutrients + climate,
  nutrients ~ landuse ,
exposure = "invasion", #wont run if current biodiersity  also effects current exotic because then the graph is not acyclic
 outcome = "native_biodiversity",
labels = c(outcome = "Native Biodiversity",
           exposure = "Invasion"))

set.seed(124)
ggdag(DAG_invasion_effects, 
       use_labels = "label")

ggdag_status(DAG_invasion_effects,
             use_labels = "label",
             text = TRUE,
             label_alpha = 0.5) + theme_dag()
```

To identify  what must be controlled for, we can use adjustmentSets(). We can also have a summary of all possible paths in the DAG and identify which are open vs closed backdoors using paths(). 

This function takes a DAG, with a given “exposure” or "treatment variable" and an “outcome” and identifies open backdoors: confounding variables (common causes) that need to be controlled for. 

We can also check to see which variables are conditionally independent of one another using impliedConditionalIndependencies().

```{r, echo = TRUE}
#identify the open paths that need to be adjusted for 
paths(DAG_invasion_effects)
#identify the covariaters need to be adjusted for to meet the back-door criterion
adjustmentSets(DAG_invasion_effects)

#plot the open  paths 
ggdag_paths(DAG_invasion_effects)
ggdag_paths(DAG_invasion_effects, shadow = TRUE) #

#you can identify "descendant nodes" 
ggdag_descendants(DAG_invasion_effects, "landuse")

# Finally, you can also visulaize the variables that need to be adjusted for (which is also told to you by
# the adjustmentSets() function 
ggdag_adjustment_set(DAG_invasion_effects, shadow = TRUE)

impliedConditionalIndependencies(DAG_invasion_effects)
```

# A more complex case
I am currently working on a project led by Jane Catford with the Nutrient Network. We are analysing time-series data from 61 NutNet sites located in 14 countries and 6 continents. We will use species abundance and diversity trends over time (> or = 5 years) in control and nutrient-addition plots, and in sites that range in extent of human-driven environmental change, to disentangle various mechanistic scenarios including whether: 
i)	exotic plants effectively replace native species lost because of environmental change, filling their now-vacant niches;

ii)	native species are competitively displaced by invading exotic species, whether assisted by environmental change or not (Fig. 2c-f); or 
iii)	environmental change independently drives both responses (Fig. 2b).

Determining whether exotic invasion and native diversity loss are both consequences of environmental change, or whether invasion directly drives the loss of native diversity is crucial for understanding and mitigating impacts of invasion and other forms of global change on biodiversity. 

The aim of the project is to test the following hypotheses: 

The study design includes plots, within sites, with the treatment applied in treated plots (as opposed to control plots) for multiple years. Thus. 

We have subscripts for p for plot; s for site, and y for year. 

Native_psy - \
Exotic_psy - \
NPKTreatment\
Exotics_yr0 \
Native_yr0 \
Ndep_sy \
Climate_sy \
SoilFert_yr0 \
livestock_sy \
Dist_to_Road_s \
Oldfield_past_s \
pastlivestock_yr0 \

```{r, echo = FALSE, warning = FALSE}

```

The challenge is DAGs need to be *Acyclic* - so no feedbacks ! So now we just have past richness affecting current exotic (not contemporaneous because otherwise isnt acyclic graph)!


## Here's the DAG: 
```{r}
richness_dag <- dagify(Native_psy ~ Exotic_psy + NPKTreatment + Exotics_yr0 + Native_yr0 + Ndep_sy + Climate_sy + SoilFert_yr0 +  livestock_sy + Dist_to_Road_s + Oldfield_past_s + pastlivestock_yr0, 
 Exotic_psy ~  NPKTreatment + Exotics_yr0 + Native_yr0 + Ndep_sy + Climate_sy + SoilFert_yr0 +
 livestock_sy + Dist_to_Road_s + Oldfield_past_s + pastlivestock_yr0, 
 Ndep_sy ~  Climate_sy, 
 Exotics_yr0 ~ Climate_sy + Ndep_sy + pastlivestock_yr0 + livestock_sy + Dist_to_Road_s + SoilFert_yr0,
 Native_yr0 ~ Climate_sy + pastlivestock_yr0 + livestock_sy + SoilFert_yr0, 
   SoilFert_yr0 ~ Ndep_sy + Oldfield_past_s +  livestock_sy +  pastlivestock_yr0, 
  Oldfield_past_s  ~ Dist_to_Road_s, 
  livestock_sy  ~ pastlivestock_yr0 + Dist_to_Road_s,
   pastlivestock_yr0 ~ Dist_to_Road_s, 
  exposure = "Exotic_psy", #wont run if current richess also effects current exotic 
  outcome = "Native_psy",
 labels = c(outcome = "richness",
           exposure = "Exotic"))

set.seed(124)
ggdag(richness_dag, 
       use_labels = "label")
```


```{r}
ggdag_status(richness_dag,
             use_labels = "label",
             text = TRUE,
             label_alpha = 0.5) + theme_dag()
  #identify the paths that need to be adjusted for 
paths(richness_dag)
adjustmentSets(richness_dag, effect = "direct")
adjustmentSets(richness_dag, effect = "total")
ggdag_paths(richness_dag)
ggdag_paths(richness_dag, shadow = TRUE)
ggdag_adjustment_set(richness_dag, shadow = TRUE)
ggdag_descendants(richness_dag, "Climate_sy")
ggdag_descendants(richness_dag, "Ndep_sy")

impliedConditionalIndependencies(richness_dag)

# We can also find all the paths between x and y using the paths() function from the dagitty package. We can see that there are three open paths between x and y:
paths(richness_dag)
```

```{r}
NPK_dag <- dagify(Native_psy ~ Exotic_psy + NPKTreatment + Exotics_yr0 + Native_yr0 + Ndep_sy + Climate_sy + SoilFert_yr0 +  livestock_sy + Dist_to_Road_s + Oldfield_past_s + pastlivestock_yr0, 
 Exotic_psy ~  NPKTreatment + Exotics_yr0 + Native_yr0 + Ndep_sy + Climate_sy + SoilFert_yr0 +
 livestock_sy + Dist_to_Road_s + Oldfield_past_s + pastlivestock_yr0, 
 Ndep_sy ~  Climate_sy, 
 Exotics_yr0 ~ Climate_sy + Ndep_sy + pastlivestock_yr0 + livestock_sy + Dist_to_Road_s + SoilFert_yr0,
 Native_yr0 ~ Climate_sy + pastlivestock_yr0 + livestock_sy + SoilFert_yr0, 
   SoilFert_yr0 ~ Ndep_sy + Oldfield_past_s +  livestock_sy +  pastlivestock_yr0, 
  Oldfield_past_s  ~ Dist_to_Road_s, 
  livestock_sy  ~ pastlivestock_yr0 + Dist_to_Road_s,
   pastlivestock_yr0 ~ Dist_to_Road_s, 
  exposure = "NPKTreatment", 
  outcome = "Native_psy",
 labels = c(outcome = "richness",
           exposure = "NPKTreatment"))

ggdag_status(NPK_dag,
             use_labels = "label",
             text = TRUE,
             label_alpha = 0.5) + theme_dag()

adjustmentSets(NPK_dag, effect = "total")
```     

# Your turn to practice. 
## Let's plot the Arif et al. (2022) Coral Reef Example for more practice!
You'll note, to analyze the DAG, you'll need to specify the exposure and the outcome. To look at a bunch of different relationships, this needs to be done one by one to avoid a "causal salad" in the amazing terms of Arif et al. 

*You can practice writing code to do this for a given exposure and outcome, modifying the code above for this example below!*

```{r}
seychelles <- dagify(
  regime_shift ~ initial_algae + wave_exposure + herbivore_biomass + depth + nutrients + branching_coral + structural_complexity,
  initial_algae ~ wave_exposure + herbivore_biomass + nutrients,
  herbivore_biomass ~ mpa + structural_complexity,
  nutrients ~ depth,
  branching_coral ~ mpa + depth + wave_exposure,
  structural_complexity ~ branching_coral
)

plot(seychelles)
```

