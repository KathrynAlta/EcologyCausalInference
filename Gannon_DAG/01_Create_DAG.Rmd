---
title: Constructing a DAG for Anoxic Duration Under Ice and the Concentration of Dissolved
  Organic Matter in Fall
author: "Katie Gannon"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Setting Up R Environment

```{r cars, echo= TRUE, warning = FALSE}
library(ggdag)
require(knitr)
library(dagitty)
require(tidyr)
require(ddplyr)
library(tidyverse)
```

# Project Overview
<span style="color:purple;">
*Katie Comment:* I study lakes and for one of my projects I am interested in the processes happening under lake ice in winter. I will be using this exercise to explore how the amount of organic matter (measured as the concentration of dissolved organic carbon or DOC) in the water of a lake in the fall impacts the duration of anoxia (no oxygen) in bottom waters of mountain lakes. 
</span> 

<span style="color:purple;">
Here are all of the variables that I initially included in my DAG After going through this exercise I realize that I can certainly simplify some of these! 
</span>

 **Variable name   **   | **Description    **                                                                         | 
----------------------- | ------------------------------------------------------------------------------------------- 
| $\text{anox_duration}$    |  The amount of time (measured in days) that the water at the bottom of the lake has an oxygen concentration under 0.5 mg/L |
$\text{O2_at_Freeze}$          | The total amount of oxygen present in the lake when the lake freezes in the fall |
$\text{Ice_Duration}$ | Amount of time (measured in days) that ice is on the lake in the winter |
$\text{Rare of O2 Drawdown}$ | NThe rate of oxygen depletion under ice |
$\text{Lake Volume}$  |  Volume of water in the lake  |
$\text{Fall Mixing Duration}$  | Number of days that the lake was fully mixed in fall |
$\text{Freezing Degree Days }$  | Number of days when the air temperature was bellow freezing  |
$\text{Snow Accumulation}$  |  Snow depth on the lake |
$\text{Ice Thickness}$  | Thickness of ice measured in cm|
$\text{SWE}$  | Snow water equivalents |
$\text{ER Under Ice}$  | Rate of ecosystem respiration occuring under ice  |
$\text{GPP Under Ice}$  | Rate of gross primary productivity under ice |
$\text{Summer GPP}$  | Rate of gross primary productivity the previous summer |
$\text{Terrestrial DOC Inputs}$  | Organic matter inputs to the lake from the watershed during summer |
$\text{DOC at freezing}$  | Amount of organic matter present in the lake when the ice freezes measured as concentration of dissolved organic matter |

# Identifying Variables of Interest
(set the seed when plotting because otherwise the DAG shows up in different orientations each time!) 

```{r}

# Create DAG  

    DAG_oxygen_under_ice <- dagify(
      
      #Identify Relatiobships 
      anox_duration ~ O2_at_Freeze + Ice_Duration + Rate_O2_Drawdown,
      Rate_O2_Drawdown ~ ER_under_ice + GPP_under_ice, 
      ER_under_ice ~ Freezing_Degree_Days + DOC_at_Freeze,
      DOC_at_Freeze ~ Terrestrial_DOC_Inputs + Summer_GPP, 
      GPP_under_ice ~ Summer_GPP + Light_Availability,
      Light_Availability ~ Snow_Accumulation + Ice_Thickness + Lake + Year,
      Ice_Thickness ~ Freezing_Degree_Days,
      Ice_Duration ~ Freezing_Degree_Days + Snow_Accumulation, 
      O2_at_Freeze ~ Summer_GPP + Lake + Fall_Mixing,
      Summer_GPP~ Terrestrial_DOC_Inputs + Lake + Year,
      Freezing_Degree_Days ~ Lake + Year, 
      Snow_Accumulation ~ Lake + Year,
      Terrestrial_DOC_Inputs ~ Lake + Year, 
      Fall_Mixing ~ Lake + Year, 
      
      # Specify exposure and outcome 
      exposure = "DOC_at_Freeze", 
      outcome = "anox_duration",
      
      # Label 
      labels = c(outcome = "Annoxic Duration",
                 exposure = "DOC at Lake Freeze "))


# Visualize DAG
set.seed(124)

ggdag_status(DAG_oxygen_under_ice,
             use_labels = "label",
             text = TRUE,
              text_col = "black",
             label_alpha = 0.5) + theme_dag()

```

<span style="color:purple;">
*Katie Comment:* Cleaning up code and trying to streamline to only the DAG that I need  
</span>

#Identify what must be controled for using adjustmentSets(). 
We can also have a summary of all possible paths in the DAG and identify which are open vs closed backdoors using paths(). 
This function takes a DAG, with a given “exposure” or "treatment variable" and an “outcome” and identifies open backdoors: confounding variables (common causes) that need to be controlled for. 

```{r, echo = TRUE}
#identify the open paths that need to be adjusted for 
paths(DAG_oxygen_under_ice)

#plot the open  paths (aka a mess of bubbles)
ggdag_paths(DAG_oxygen_under_ice, shadow = TRUE) #Also, do not forget to set the argument shadow = TRUE, so that the arrows from the adjusted nodes are included

```
<span style="color:purple;">
[*Katie Comment:* Alrighty, looks like we have 5 open paths. Super hard to tell from the graphs exactly what is in those paths. But from the print out we can get a better idea. Here are the open paths as far as I understand ]
</span>


 
# Identify Decendent Nodes 
```{r, echo = TRUE}
#you can identify "descendant nodes" 
ggdag_descendants(DAG_oxygen_under_ice, "DOC_at_Freeze") 
# this gives you all of the variables taht are direct decendents of (impacted by) "DOC at Freeze" 
```

# Identify and Visualize Covariates that need to be adjusted for 
```{r, echo = TRUE}
#identify the covariaters need to be adjusted for to meet the back-door criterion
adjustmentSets(DAG_oxygen_under_ice)

# Finally, you can also visulaize the variables that need to be adjusted for (which is also told to you by the adjustmentSets() function 
ggdag_adjustment_set(DAG_oxygen_under_ice, shadow = TRUE) 
#Also, do not forget to set the argument shadow = TRUE, so that the arrows from the adjusted nodes are included.
```

<span style="color:purple;">
[*Katie Comment:* Ahh! I see! This is so handy. It tells me what I need to condition on. Or at least it gives me options for pathways that I can condition on to close all of the backdoor. In this case I would choose to condition on Summer GPP to minimize the number of variables in my model. That also happens to be super handy because it is an easy variable to measure (we also have proxies in the form of summer chlorophyl). Really interesting fiddling with the question I am asking ("What if the causal question is "how does summer GPP impact anoxic duration?") and in that case it completely changes the adjustments you need and there is only one option! In that case we would need to condition on summer terrestrial DOC inputs ]
</span>

#Check Conditional independeces
We can also check to see which variables are conditionally independences in the DAG using impliedConditionalIndependencies().
```{r, echo = TRUE}
# Identify the implied conditional dependencies
impliedConditionalIndependencies(DAG_oxygen_under_ice)
```

<span style="color:purple;">
[*Katie Comment:* Well that is a terrifyingly long list of conditional indipendicies. I think that I might need to more explicitly time step some of my variables. For example GPP and ER do impact eachother in each direction. So I need to specify GPP of the previous summer impacting ER under ice in winter etc.]
</span>

<span style="color:purple;">
[*Questions:* Including lake and year as random effects?]</span>





